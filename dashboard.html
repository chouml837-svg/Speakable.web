<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard</title>

  <style>
    * {
      margin: 0; padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background: #d7b899;
    }
    .container {
      display: none;
      padding: 20px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .back-btn {
      background: #007bff; color: white;
      border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer;
    }
    .profile-header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 20px;
      opacity: 0; transform: translateY(-20px);
      transition: 0.4s ease;
    }
    .profile-header.show {
      opacity: 1; transform: translateY(0);
    }
    .profile-left {
      display: flex; align-items: center; gap: 15px;
    }
    .avatar {
      width: 80px; height: 80px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      background-color: #ddd;
      cursor: pointer;
    }
    .profile-info h2 { font-size: 20px; }
    .profile-info p { font-size: 14px; color: #555; }
    .edit-btn {
      padding: 5px 10px;
      background: #007bff; color: white;
      border: none; border-radius: 5px;
      cursor: pointer; font-size: 12px;
    }
    .save-btn {
      background: #28a745; color: white;
      border: none; padding: 8px 12px;
      border-radius: 5px; cursor: pointer;
    }
    .stats {
      display: flex; justify-content: space-between;
      margin: 20px 0;
    }
    .stat {
      flex: 1; text-align: center;
      padding: 10px; background: white;
      border-radius: 10px; margin: 0 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .book-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px; margin-top: 20px;
    }
    .book-card {
      background: white; padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .edit-form {
      display: none; margin-top: 15px;
      background: white; padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
    }
    .edit-form label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: bold;
      color: #333;
    }
    .edit-form input, .edit-form select {
      width: 100%; margin-bottom: 15px;
      padding: 8px; border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container" id="profileContainer">

    <div class="top-bar">
      <button class="back-btn" onclick="window.location.href='admin.html'">‚Üê Back</button>
    </div>

    <div class="profile-header" id="profileHeader">
      <div class="profile-left">
        <div id="avatar" class="avatar"></div>
        <div class="profile-info">
          <h2 id="username">Teacher</h2>
          <p id="userDetails">Role: Teacher | Gender: Unknown</p>
        </div>
      </div>
      <button class="edit-btn" id="editProfileBtn">Edit Profile</button>
    </div>

    <div class="stats">
      <div class="stat"><strong id="booksRead">0</strong><br>Books Read</div>
      <div class="stat"><strong id="readingTime">0</strong><br>Reading Time</div>
    </div>

    <h3>Reading History</h3>
    <div class="book-grid" id="bookGrid"></div>

    <div class="edit-form" id="editForm">
      <label for="editName">Name</label>
      <input type="text" id="editName" placeholder="Enter name"/>

      <label for="editGender">Gender</label>
      <select id="editGender">
        <option value="Unknown">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>

      <label for="editAvatar">Profile Picture</label>
      <input type="file" id="editAvatar" accept="image/*"/>

      <button class="save-btn" id="saveProfileBtn">Save</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyACbKYi7hpqNCiFysWLyt6-eKpsSDdi4W8",
    authDomain: "speakable-7f5cf.firebaseapp.com",
    databaseURL: "https://speakable-7f5cf-default-rtdb.firebaseio.com",
    projectId: "speakable-7f5cf",
    storageBucket: "speakable-7f5cf.appspot.com",
    messagingSenderId: "919521788374",
    appId: "1:919521788374:web:66ddbcea40541e3f052477"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const profileContainer = document.getElementById("profileContainer");
  const profileHeader = document.getElementById("profileHeader");
  const avatarEl = document.getElementById("avatar");
  const usernameEl = document.getElementById("username");
  const userDetailsEl = document.getElementById("userDetails");
  const booksReadEl = document.getElementById("booksRead");
  const readingTimeEl = document.getElementById("readingTime");
  const bookGrid = document.getElementById("bookGrid");
  const editForm = document.getElementById("editForm");
  const editProfileBtn = document.getElementById("editProfileBtn");
  const saveProfileBtn = document.getElementById("saveProfileBtn");
  const editNameInput = document.getElementById("editName");
  const editGenderInput = document.getElementById("editGender");
  const editAvatarInput = document.getElementById("editAvatar");

  let currentUser = null;
  let currentUserData = null;

  async function loadUser() {
    currentUser = localStorage.getItem("activeUser");
    if (!currentUser) {
      updateProfile({ role: "Teacher", gender: "Unknown" }, "Teacher");
      return;
    }
    const snap = await get(ref(db, "users/" + currentUser));
    if (snap.exists()) {
      currentUserData = snap.val();
      updateProfile(currentUserData, currentUser);
    } else {
      updateProfile({ role: "Teacher", gender: "Unknown" }, "Teacher");
    }
  }

  function updateProfile(user, name) {
    currentUserData = user;
    usernameEl.textContent = user.name || name || "Teacher";
    userDetailsEl.textContent = `Role: Teacher | Gender: ${user.gender || "Unknown"}`;
    avatarEl.style.backgroundImage = `url('${user.profileImage || "default.png"}')`;

    profileContainer.style.display = "block";
    setTimeout(() => profileHeader.classList.add("show"), 100);

    const books = user.booksRead || [];
    booksReadEl.textContent = books.length;

    let totalTime = 0;
    books.forEach(b => { totalTime += b.readingTime || 0; });

    const hours = Math.floor(totalTime / 3600);
    const minutes = Math.floor((totalTime % 3600) / 60);
    const seconds = totalTime % 60;
    readingTimeEl.textContent =
      (hours > 0 ? hours + "h " : "") +
      (minutes > 0 ? minutes + "m " : "") +
      (seconds > 0 ? seconds + "s" : (hours === 0 && minutes === 0 ? "0s" : ""));

    if (books.length === 0) {
      bookGrid.innerHTML = "<p>No books yet.</p>";
    } else {
      bookGrid.innerHTML = books.map(b => `<div class="book-card"><p>${b.title}</p></div>`).join("");
    }
  }

  editProfileBtn.addEventListener("click", () => {
    editNameInput.value = currentUserData.name || currentUser;
    editGenderInput.value = currentUserData.gender || "Unknown";
    editForm.style.display = editForm.style.display === "block" ? "none" : "block";
  });

  saveProfileBtn.addEventListener("click", async () => {
    if (!currentUser) return;

    let imageUrl = currentUserData.profileImage || "default.png";
    const newName = editNameInput.value || currentUser;

    const saveUpdatedUser = async () => {
      const updatedUser = {
        name: newName,
        gender: editGenderInput.value || "Unknown",
        role: "Teacher",
        profileImage: imageUrl,
        booksRead: currentUserData.booksRead || []
      };

      if (newName !== currentUser) {
        await remove(ref(db, "users/" + currentUser));
        await set(ref(db, "users/" + newName), updatedUser);
        localStorage.setItem("activeUser", newName);
        currentUser = newName;
      } else {
        await set(ref(db, "users/" + currentUser), updatedUser);
      }

      updateProfile(updatedUser, updatedUser.name);
      editForm.style.display = "none";
    };

    if (editAvatarInput.files && editAvatarInput.files[0]) {
      const reader = new FileReader();
      reader.onload = e => { imageUrl = e.target.result; saveUpdatedUser(); };
      reader.readAsDataURL(editAvatarInput.files[0]);
    } else {
      saveUpdatedUser();
    }
  });

  loadUser();
</script>
</body>
</html>